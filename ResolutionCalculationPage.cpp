#include "ResolutionCalculationPage.h"
#include "qevent.h"
#include "ui_ResolutionCalculationPage.h"

ResolutionCalculationPage::ResolutionCalculationPage(QWidget *parent) :
    QWidget(parent),
    ui(new Ui::ResolutionCalculationPage)
{
    ui->setupUi(this);
    setWindowFlag(Qt::Window);
    setWindowTitle(QString("波长分辨率计算"));
    setWindowFlags(this->windowFlags() & ~Qt::WindowMinMaxButtonsHint & ~Qt::WindowMaximizeButtonHint); // 去掉configui界面的最小化和最大化按钮

    QIntValidator *validator = new QIntValidator(0, 2048, this);
    ui->lineEdit_endPoint1->setValidator(validator);
    ui->lineEdit_endPoint2->setValidator(validator);
    ui->lineEdit_endPoint3->setValidator(validator);
    ui->lineEdit_startPoint1->setValidator(validator);
    ui->lineEdit_startPoint2->setValidator(validator);
    ui->lineEdit_startPoint3->setValidator(validator);

    ui->lineEdit_startPoint1->setText(QString::number(peak1.i_start));
    ui->lineEdit_startPoint2->setText(QString::number(peak2.i_start));
    ui->lineEdit_startPoint3->setText(QString::number(peak3.i_start));

    ui->lineEdit_endPoint1->setText(QString::number(peak1.i_end));
    ui->lineEdit_endPoint2->setText(QString::number(peak2.i_end));
    ui->lineEdit_endPoint3->setText(QString::number(peak3.i_end));

    ui->lineEdit_wavelength1->setText(QString::number(peak1.wave));
    ui->lineEdit_wavelength2->setText(QString::number(peak2.wave));
    ui->lineEdit_wavelength3->setText(QString::number(peak3.wave));

    ui->lineEdit_resolution1->setReadOnly(true);
    ui->lineEdit_resolution2->setReadOnly(true);
    ui->lineEdit_resolution3->setReadOnly(true);

    QPalette palette;
    palette.setBrush(QPalette::Base, Qt::gray);
    ui->lineEdit_resolution1->setPalette(palette);
    ui->lineEdit_resolution2->setPalette(palette);
    ui->lineEdit_resolution3->setPalette(palette);

    ui->pushButton_StartCalcul->setText(QString("开始计算"));
    ui->pushButton_Cancel->setText(QString("取消"));

    QObject::connect(ui->pushButton_StartCalcul, &QPushButton::clicked, this, &ResolutionCalculationPage::slotStartResolutionCalculation);
    QObject::connect(ui->pushButton_Cancel, &QPushButton::clicked, this, &ResolutionCalculationPage::close);
}

ResolutionCalculationPage::~ResolutionCalculationPage()
{
    delete ui;
}

void ResolutionCalculationPage::closeEvent(QCloseEvent *event)
{
    deleteLater();
    QWidget::closeEvent(event);
}

double ResolutionCalculationPage::Func_Cal_Wave_Resolution(quint16 nLength, double *spectrum, stru_peak peak1, stru_peak peak2, int n_interp)
{
    Q_UNUSED(nLength)

    unsigned short index_max_1 = 0;
    unsigned short index_max_2 = 0;

    double average_resolution;

    // 分别查找两个峰值的位置

    Func_max_interp(&spectrum[peak1.i_start],peak1.i_end-peak1.i_start+1 ,&index_max_1,n_interp);
    index_max_1 = peak1.i_start*n_interp + index_max_1;

    Func_max_interp(&spectrum[peak2.i_start],peak2.i_end-peak2.i_start+1 ,&index_max_2,n_interp);
    index_max_2 = peak2.i_start*n_interp + index_max_2;

    average_resolution = (peak2.wave-peak1.wave)/(index_max_2-index_max_1);

    return average_resolution;
}

double ResolutionCalculationPage::Func_Cal_semiband_width(unsigned short nLength, double *spectrum, stru_peak peak, int n_interp)
{
    Q_UNUSED(nLength)

    int i=0;
    unsigned short index_max=0;
    int i_left,i_right;
    double arr_interp[4028];
    double v_max,v_base;
    int arr_n = peak.i_end-peak.i_start+1;
    double *arr = &spectrum[peak.i_start];
    int arr_m = (arr_n-1)*n_interp+1;
    double semiband;

    if(arr_m>4028) return 0;

    spline(arr_n,arr,arr_m,arr_interp,n_interp);

    Func_max(arr_interp,arr_m,&index_max);

    // 寻找半带宽
    v_max = arr_interp[index_max];
    v_base = arr_interp[index_max-100];
    i_left = index_max;
    i_right = index_max;

    for(i=index_max;i>index_max-100;i--)
    {
        if((arr_interp[i]-v_base<=(v_max-v_base)*0.5))
        {
            i_left = i;
            break;
        }
    }

    for(i=index_max;i<index_max+50;i++)
    {
        if((arr_interp[i]-v_base<=(v_max-v_base)*0.5))
        {
            i_right = i;
            break;
        }
    }

    semiband = i_right - i_left;

    return semiband;
}

void ResolutionCalculationPage::Func_max_interp(double *arr, quint16 arr_n, quint16 *index_max, quint16 n_interp)
{
    int arr_m;
    double arr_interp[4028];
    //unsigned short idx_max_m;

    arr_m = (arr_n-1)*n_interp+1;

    if(arr_m>4028) return;

    spline(arr_n,arr,arr_m,arr_interp,n_interp);

    Func_max(arr_interp,arr_m,index_max);

    return;
}

void ResolutionCalculationPage::Func_max(double *arr, unsigned short arr_n, unsigned short *index_max)
{
    int i= 0;
    double value_max;
    int i_max;

    if(arr==0 || arr_n<=0) return;

    value_max=arr[0];
    i_max = 0;
    for(i=1;i<arr_n;i++)
    {
        if(arr[i]>=value_max)
        {
            value_max = arr[i];
            i_max = i;
        }
    }

    *index_max = i_max;
    return;
}

void ResolutionCalculationPage::spline(int n, double *spec_in, int m, double *spec_out, int n_interp)
{
    Q_UNUSED(n_interp)

    double a[380+6],b[380+6],c[380+6],d[380+6],s[380+6],x[380+6];//n=380+6,n_interp=5;//20190226改
    double a1[380+6],b1[380+6],c1[380+6],d1[380+6];//20190226改
    double xx[1926];//20190226改

    int i,j,k;
    double step,h;

    double *y = spec_in;
    double *yy = spec_out;

    if(y==0 || yy==0) return;

    for(i=0;i<n;i++)
    {
        x[i]=i;
    }

    step =(x[n-1]-x[0])/(m-1.0);
    xx[0]=x[0];
    xx[m-1]=x[n-1];
    for(i=1;i<m;i++)
    {
        if( (xx[i-1]+step)<x[n-1] )
        {
            xx[i]=xx[i-1]+step;
        }
    }


    a[0]=0;
    for(i=1;i<n-2;i++)
    {
        a[i]=x[i]-x[i-1];
    }

    for(i=0;i<n-2;i++)
    {
        b[i]=2*(x[i+1]-x[i] +x[i+2]-x[i+1]);
    }

    for(i=0;i<n-3;i++)
    {
        c[i]=x[i+2]-x[i+1];
    }
    c[n-3]=0;

    for(i=0;i<n-2;i++)
    {
        d[i]= 6*(y[i+2]-y[i+1])/(x[i+2]-x[i+1])-6*(y[i+1]-y[i])/(x[i+1]-x[i]);
    }

    // chase method
    chase(a,b,c,d,s,n-2);

    for(i=0;i<n-1;i++)
    {
        a1[i]=(s[i+1]-s[i])/6/(x[i+1]-x[i]);
        b1[i]=s[i]/2;
        c1[i]=(y[i+1]-y[i])/(x[i+1]-x[i])-(2*(x[i+1]-x[i])*s[i]+(x[i+1]-x[i])*s[i+1])/6;
        d1[i]=y[i];

        //	printf("a1[%d]=%f b1[%d]=%f c1[%d]=%f d1[%d]=%f\n",i,a1[i],i,b1[i],i,c1[i],i,d1[i]);
    }

    i=0;
    k=0;

    for(j=0;j<m;j++)
    {
        if(xx[j]>x[i])
        {
            k=i;
            i=i+1;
        }

        h=xx[j]-x[k];
        //	printf("xx[%d]=%f\n",j,xx[j]); //没有问题

        //	printf("a1[%d]=%f b1[%d]=%f c1[%d]=%f d1[%d]=%f\n",k,a1[k],k,b1[k],k,c1[k],k,d1[k]);
        yy[j]=a1[k]*pow(h,3)+b1[k]*pow(h,2)+c1[k]*h+d1[k];
        //		printf("xx[%d]=%f yy[%d]=%f\n",j,xx[j],j,yy[j]);
    }
}

void ResolutionCalculationPage::chase(double *a, double *b, double *c, double *d, double *s, int n)
{
    int i;

    double r[380+6],x[380+6],y[380+6];//20190226改

    for(i=0;i<386;i++)
    {
        r[i]=0;
        x[i]=0;
        y[i]=0;
    }

    if(a==0)
        return;
    if(b==0)
        return;
    if(c==0)
        return;

    r[0]=c[0]/b[0];
    y[0]=d[0]/b[0];

    for(i=1;i<n;i++)
    {
        r[i]=c[i]/( b[i]-a[i]*r[i-1] );
        y[i]=(d[i]-a[i]*y[i-1])/( b[i]-a[i]*r[i-1]);
    }

    x[n-1]=y[n-1];

    for(i=n-1;i>=0;i--)
    {
        x[i]=y[i]-r[i]*x[i+1];
    }

    for(i=0;i<n;i++)
    {
        s[i+1]=x[i];
    }
    s[0]=0;
    s[n+1]=0;
}

/*************************************************
 * 函数类别：自定义槽函数
 * 函数功能：
 * 函数参数：null
 * 返回对象：
 * 链接对象：
 * 修改时间：2023/7/6
 * 联系邮箱：2282669851@qq.com
 *************************************************/
void ResolutionCalculationPage::slotStartResolutionCalculation()
{
    if (ui->pushButton_StartCalcul->text() == "开始计算") {
        ui->pushButton_StartCalcul->setText("停止计算");

        int spoint1 = ui->lineEdit_startPoint1->text().toInt();
        int spoint2 = ui->lineEdit_startPoint2->text().toInt();
        int spoint3 = ui->lineEdit_startPoint3->text().toInt();

        int epoint1 = ui->lineEdit_endPoint1->text().toInt();
        int epoint2 = ui->lineEdit_endPoint2->text().toInt();
        int epoint3 = ui->lineEdit_endPoint3->text().toInt();

        double wave1 = ui->lineEdit_wavelength1->text().toDouble();
        double wave2 = ui->lineEdit_wavelength2->text().toDouble();
        double wave3 = ui->lineEdit_wavelength3->text().toDouble();

        peak1.i_start = spoint1;
        peak1.i_end = epoint1;
        peak1.wave = wave1;

        peak2.i_start = spoint2;
        peak2.i_end = epoint2;
        peak2.wave = wave2;

        peak3.i_start = spoint3;
        peak3.i_end = epoint3;
        peak3.wave = wave3;

        ui->lineEdit_startPoint1->setReadOnly(true);
        ui->lineEdit_startPoint2->setReadOnly(true);
        ui->lineEdit_startPoint3->setReadOnly(true);

        ui->lineEdit_endPoint1->setReadOnly(true);
        ui->lineEdit_endPoint2->setReadOnly(true);
        ui->lineEdit_endPoint3->setReadOnly(true);

        ui->lineEdit_wavelength1->setReadOnly(true);
        ui->lineEdit_wavelength2->setReadOnly(true);
        ui->lineEdit_wavelength3->setReadOnly(true);

        // 开启实时计算标志位
        isCalculating = true;
    } else {
        ui->pushButton_StartCalcul->setText("开始计算");

        ui->lineEdit_startPoint1->setReadOnly(false);
        ui->lineEdit_startPoint2->setReadOnly(false);
        ui->lineEdit_startPoint3->setReadOnly(false);

        ui->lineEdit_endPoint1->setReadOnly(false);
        ui->lineEdit_endPoint2->setReadOnly(false);
        ui->lineEdit_endPoint3->setReadOnly(false);

        ui->lineEdit_wavelength1->setReadOnly(false);
        ui->lineEdit_wavelength2->setReadOnly(false);
        ui->lineEdit_wavelength3->setReadOnly(false);

        isCalculating = false;
    }
}

void ResolutionCalculationPage::slotGetCurrentSerialData(QVector<double> data)
{
    this->seriesData = data;
}

// 新数据实时计算
void ResolutionCalculationPage::slotNewData(QVector<double> data)
{
#define SPECTRUMPOINTS 2048

    Q_UNUSED(data);
//    double test_spec[SPECTRUMPOINTS] = {807.800000000000,846.400000000000,785.800000000000,814.800000000000,793.200000000000,776.200000000000,798.200000000000,807,747.800000000000,780.800000000000,763,755.600000000000,809.200000000000,799.800000000000,794.800000000000,792.200000000000,773.400000000000,821.800000000000,811.400000000000,963.600000000000,1036.60000000000,1155.20000000000,1158.20000000000,1336.20000000000,1490.20000000000,1615.60000000000,1427.80000000000,1057,896.800000000000,796.800000000000,843.800000000000,848.800000000000,827.800000000000,848.800000000000,794.600000000000,795,822.600000000000,808.800000000000,793.400000000000,802.400000000000,805,849.200000000000,751.400000000000,842,766.400000000000,865,831.600000000000,769.600000000000,794.600000000000,834.600000000000,791.800000000000,814.800000000000,769,799,802.400000000000,821.600000000000,788.400000000000,816.600000000000,783.200000000000,833.200000000000,779.800000000000,781.600000000000,799.600000000000,776.400000000000,808,804.800000000000,782.600000000000,817.400000000000,775.800000000000,817.800000000000,794.200000000000,784.400000000000,810.800000000000,825.200000000000,774.200000000000,773.800000000000,787.400000000000,798.400000000000,772.400000000000,790.800000000000,815.800000000000,798.600000000000,757.400000000000,791,796.600000000000,805.600000000000,796.600000000000,766.600000000000,786,781.600000000000,723.200000000000,793.400000000000,779.400000000000,787.200000000000,752,806.400000000000,777.200000000000,792,782,811.600000000000,774,809.600000000000,780.800000000000,807.200000000000,771.200000000000,773,793.800000000000,806,785.400000000000,810.600000000000,815.400000000000,781.600000000000,772,766.800000000000,791.200000000000,769.800000000000,727.600000000000,788,767.800000000000,803,831.400000000000,764.600000000000,786.600000000000,779.400000000000,749.800000000000,787.800000000000,816.600000000000,804,787.200000000000,770.200000000000,779.800000000000,796.200000000000,782.800000000000,784.800000000000,800.800000000000,795.600000000000,829,809.200000000000,832.200000000000,801.800000000000,780.200000000000,788,744,800.200000000000,751,796.600000000000,698.200000000000,812.600000000000,770.200000000000,790,773.200000000000,796.600000000000,783.600000000000,794.800000000000,759.600000000000,790,755.600000000000,777.800000000000,796.400000000000,793.800000000000,771.600000000000,778.200000000000,782,777.600000000000,828,781,749.600000000000,803.200000000000,795.400000000000,785.800000000000,750.600000000000,781.200000000000,800.400000000000,809,715,772.600000000000,758.800000000000,738.600000000000,732.600000000000,725.600000000000,756.600000000000,788.800000000000,726.800000000000,796.800000000000,786.400000000000,771,762,774.400000000000,756.600000000000,744.600000000000,763.400000000000,765.200000000000,751.600000000000,771.600000000000,715.200000000000,778.200000000000,712.400000000000,722.800000000000,746.800000000000,721.400000000000,719,769,810.200000000000,767.600000000000,749.400000000000,769.600000000000,782.200000000000,777.600000000000,771,778.200000000000,753,771.200000000000,841.200000000000,766.400000000000,747.600000000000,772.800000000000,729.800000000000,760.400000000000,783.800000000000,763,730.800000000000,767.600000000000,762.800000000000,778,775.400000000000,759.600000000000,753.800000000000,747.200000000000,754,784,781.200000000000,749.400000000000,763.600000000000,768.800000000000,771.600000000000,750.400000000000,757.800000000000,747.400000000000,740.400000000000,767.800000000000,710.400000000000,782.600000000000,747.400000000000,799.600000000000,746,762.600000000000,749.200000000000,753,711.200000000000,752.800000000000,744.600000000000,730,745,740.800000000000,749.800000000000,739,748,759.400000000000,730,759.600000000000,711,771,774,754,761.400000000000,753.400000000000,754.400000000000,754.200000000000,739.800000000000,746.800000000000,719.600000000000,741.400000000000,759.400000000000,760.200000000000,772.400000000000,737.600000000000,748,769.800000000000,741.400000000000,784.600000000000,773.200000000000,782.600000000000,753.400000000000,796.800000000000,745,753.200000000000,800.200000000000,756,791.800000000000,784.600000000000,765.400000000000,770.200000000000,782.800000000000,789.800000000000,710.800000000000,792.400000000000,758,784.800000000000,791.600000000000,769.200000000000,765.600000000000,713.600000000000,767.600000000000,797.400000000000,764.200000000000,731.800000000000,777.800000000000,781.200000000000,753.200000000000,758,771.600000000000,786.200000000000,783.200000000000,771.800000000000,781.200000000000,769.800000000000,798.400000000000,753,785.600000000000,801,779,817.400000000000,799.800000000000,795.400000000000,780.200000000000,763.200000000000,716.800000000000,762,759,730.800000000000,786.800000000000,821.200000000000,817.400000000000,789.200000000000,767,798.800000000000,781.200000000000,805.200000000000,779.600000000000,765.600000000000,788.400000000000,834.400000000000,714.200000000000,783.600000000000,797,751,832.200000000000,850.800000000000,850,838,870.800000000000,833.400000000000,820.600000000000,798,825.200000000000,835,810,806.400000000000,790.200000000000,814.800000000000,819.400000000000,774.200000000000,800.600000000000,841.400000000000,839.200000000000,847.800000000000,818.800000000000,912.600000000000,972.400000000000,990,1078.80000000000,1203.60000000000,1415.80000000000,2108.80000000000,8079.20000000000,18698.6000000000,20670,30619.8000000000,59688.6000000000,62115.8000000000,11963.8000000000,2042.20000000000,1250,1100.60000000000,1006.80000000000,1047.40000000000,940.800000000000,949.400000000000,905.600000000000,890,857.600000000000,842.200000000000,848.800000000000,887.800000000000,823.600000000000,810.600000000000,803.800000000000,808.200000000000,825,808.800000000000,835.400000000000,834.400000000000,805.400000000000,871,803.200000000000,819.800000000000,758,841.600000000000,819.600000000000,810,822.800000000000,788.200000000000,819.600000000000,758.400000000000,818.200000000000,791.200000000000,794,781.600000000000,779.800000000000,804.400000000000,802.600000000000,823.600000000000,800.600000000000,822.400000000000,803.200000000000,786.600000000000,772.200000000000,805.800000000000,823.600000000000,799.800000000000,763.200000000000,749.800000000000,791.400000000000,785.600000000000,755.400000000000,783.800000000000,789.800000000000,793.400000000000,821.400000000000,877.200000000000,906.800000000000,885.800000000000,802,775.600000000000,731.600000000000,786,787.800000000000,802.600000000000,776.400000000000,766,763.600000000000,776.600000000000,774,794.400000000000,784.200000000000,783.400000000000,793,783.800000000000,767.600000000000,774.600000000000,751.400000000000,763.600000000000,747.200000000000,729.800000000000,713.400000000000,737,728.400000000000,759,716.400000000000,772.800000000000,716.600000000000,710.400000000000,743.600000000000,735.600000000000,704.200000000000,696.600000000000,701.400000000000,718,714.400000000000,709.400000000000,692.800000000000,671,699.400000000000,701.400000000000,682.400000000000,745.400000000000,771.200000000000,676,688.800000000000,647.400000000000,714.400000000000,698.600000000000,674.200000000000,718.600000000000,655,700.400000000000,642.800000000000,652,682.800000000000,679.200000000000,682.800000000000,676.200000000000,641.400000000000,652.800000000000,677,646.800000000000,667.200000000000,725.800000000000,674,691.800000000000,711.600000000000,727.200000000000,713.400000000000,715.600000000000,722.200000000000,712.400000000000,722.600000000000,719.600000000000,710.400000000000,716.800000000000,679.800000000000,727.400000000000,689,714.800000000000,725.600000000000,713.400000000000,754.200000000000,735.600000000000,716.200000000000,741,784.200000000000,760,801.200000000000,775.400000000000,732.600000000000,732.200000000000,778.400000000000,758.800000000000,730,742.800000000000,755.400000000000,710.800000000000,777.600000000000,789.600000000000,737.200000000000,738.400000000000,749.200000000000,723.800000000000,752.400000000000,741.400000000000,729,654.600000000000,768.400000000000,758.400000000000,799.600000000000,729,769.200000000000,740,714,718,704.400000000000,730.600000000000,683.200000000000,718.600000000000,717,708.800000000000,719.400000000000,709.400000000000,740.600000000000,748.800000000000,803.400000000000,743.600000000000,708.600000000000,672,744.400000000000,693.200000000000,740.400000000000,698.400000000000,719,653.800000000000,661.600000000000,670.200000000000,677.800000000000,673.600000000000,640.200000000000,652.800000000000,681.800000000000,631.800000000000,673,649,557.200000000000,600,598.600000000000,586,615.600000000000,590.400000000000,609.400000000000,634.400000000000,644.200000000000,646.600000000000,683.600000000000,648.800000000000,685.400000000000,630.600000000000,632.600000000000,627.400000000000,699.400000000000,686.800000000000,920,1177.80000000000,1561.20000000000,2092.20000000000,1175.20000000000,742.800000000000,703,725.400000000000,689.800000000000,731.200000000000,738.800000000000,720.600000000000,699.600000000000,719.800000000000,709.400000000000,705.600000000000,657.800000000000,693.200000000000,692.400000000000,737.800000000000,690.200000000000,643.600000000000,703.200000000000,695.400000000000,690.200000000000,703.200000000000,704,706.200000000000,701,668.800000000000,757.200000000000,830.400000000000,976.800000000000,1003.80000000000,835,730.400000000000,694.200000000000,722.600000000000,707,706.800000000000,678.600000000000,688.200000000000,721.200000000000,696.600000000000,666.400000000000,720.600000000000,692,658.600000000000,693.600000000000,684.200000000000,704,737.400000000000,700.400000000000,710.800000000000,695.400000000000,708.400000000000,705.200000000000,688.200000000000,670.200000000000,692.200000000000,640.800000000000,676.400000000000,787.800000000000,690.600000000000,697.400000000000,698.200000000000,684.800000000000,716.800000000000,759.600000000000,686,679.600000000000,682.400000000000,674,671.200000000000,711.200000000000,723.400000000000,688.600000000000,675,672.600000000000,680.600000000000,682,658.800000000000,686.800000000000,688.800000000000,689.400000000000,695.600000000000,686,690.600000000000,878.800000000000,1298.40000000000,1977.20000000000,2232.20000000000,1770.60000000000,2135.80000000000,3461.40000000000,1782.20000000000,789.800000000000,721.600000000000,714.800000000000,762.800000000000,691.800000000000,679.400000000000,678,670.400000000000,725.600000000000,706.600000000000,662,680.600000000000,670.200000000000,666.200000000000,653,659.800000000000,667.200000000000,684,703.600000000000,676.800000000000,653,653.800000000000,656.600000000000,655.200000000000,676.800000000000,678,664.400000000000,683.200000000000,674.200000000000,646.400000000000,704.400000000000,664.800000000000,673,684,705,640.400000000000,650.600000000000,657.400000000000,590.800000000000,695.200000000000,660.800000000000,674.600000000000,634.800000000000,664.400000000000,673.200000000000,682.400000000000,672,662.800000000000,631.400000000000,671.800000000000,672.800000000000,677,648.600000000000,664.400000000000,688.800000000000,662.600000000000,682.800000000000,688.400000000000,635.600000000000,675.800000000000,665.800000000000,658.800000000000,719.200000000000,683.200000000000,693.800000000000,674.600000000000,700.400000000000,687,689,707.400000000000,693.600000000000,657.200000000000,657.800000000000,707.400000000000,689,673,686,667.800000000000,669.400000000000,673.800000000000,683.200000000000,660.400000000000,673.200000000000,655.400000000000,668,667.200000000000,686.800000000000,663.600000000000,679,665,663.800000000000,681.200000000000,663.200000000000,632.400000000000,697.400000000000,668.400000000000,654,658.200000000000,635.200000000000,669.800000000000,659.800000000000,651.200000000000,661.600000000000,646.800000000000,665.200000000000,618.400000000000,684.600000000000,687.800000000000,663.200000000000,677.800000000000,656.400000000000,655.600000000000,650.400000000000,672.800000000000,693.600000000000,748,818.800000000000,836.200000000000,706.200000000000,630.600000000000,674.600000000000,690.400000000000,677.800000000000,677.800000000000,704,668,677,680.600000000000,652.800000000000,642.400000000000,688.200000000000,680.200000000000,672.800000000000,657.800000000000,676.800000000000,663,677.400000000000,727.800000000000,688.200000000000,707.200000000000,659.200000000000,628.400000000000,633.800000000000,687.200000000000,683,692.200000000000,675,715.200000000000,676.600000000000,685.600000000000,660.200000000000,691.600000000000,671.400000000000,660,631.400000000000,667.800000000000,659.600000000000,658,708.600000000000,701.200000000000,725.400000000000,689.600000000000,685.600000000000,689.200000000000,700.400000000000,699.400000000000,685.600000000000,680.600000000000,676.800000000000,687.200000000000,674.200000000000,683.600000000000,680,698,680,668.800000000000,685.600000000000,648.600000000000,703.400000000000,690,720.600000000000,689,674,671.200000000000,671,672.400000000000,758.600000000000,691.200000000000,674.200000000000,630.400000000000,692.400000000000,697,703,641.800000000000,696.600000000000,694,725.400000000000,683,698.600000000000,697.600000000000,654.800000000000,665.800000000000,679.400000000000,624.600000000000,690.200000000000,700.800000000000,663,673.800000000000,692,672.400000000000,703.600000000000,696.800000000000,698.600000000000,687.400000000000,678.400000000000,694.400000000000,682.200000000000,707.600000000000,680.200000000000,756.600000000000,666.800000000000,656,715.600000000000,683,696.800000000000,676,714.200000000000,708,680.200000000000,679.800000000000,700.600000000000,721.600000000000,678.400000000000,656.200000000000,691.200000000000,663.200000000000,710.600000000000,740.400000000000,696.600000000000,681.400000000000,664.400000000000,685.400000000000,711.400000000000,685.600000000000,706,691.200000000000,677.400000000000,689.400000000000,704.600000000000,694.200000000000,682.800000000000,670.200000000000,666.400000000000,650.800000000000,703.200000000000,732.600000000000,705.400000000000,713,718.600000000000,689,676,677,697,709.400000000000,681,701.400000000000,667.200000000000,660.400000000000,690.800000000000,693.200000000000,682.800000000000,670.200000000000,675.600000000000,687,682.800000000000,714.200000000000,684.800000000000,696.400000000000,666,675.600000000000,703,689.400000000000,680.800000000000,695.800000000000,708.600000000000,665.200000000000,727.800000000000,726.600000000000,698.400000000000,699.200000000000,735.200000000000,700.600000000000,691.800000000000,690.800000000000,1000.60000000000,3308,2688,1430,1468.40000000000,1064.20000000000,802.800000000000,701,806.800000000000,1249.60000000000,952.200000000000,804.200000000000,720.600000000000,701.800000000000,715.800000000000,689.400000000000,698.600000000000,668,684.400000000000,709.200000000000,721.600000000000,701.400000000000,699.400000000000,689.200000000000,697,730,705.400000000000,694,706.200000000000,738,693.600000000000,680.600000000000,714.600000000000,685.600000000000,683.600000000000,724.600000000000,709.400000000000,673.400000000000,695.800000000000,686,704.400000000000,703.600000000000,715,709.600000000000,690,668.600000000000,699.800000000000,682,687.600000000000,723.200000000000,703.200000000000,704,705.800000000000,704.200000000000,683.600000000000,669,692.800000000000,711,702,730.800000000000,681.800000000000,696.400000000000,643.600000000000,704.800000000000,681.600000000000,734.200000000000,679,685.800000000000,705.600000000000,715.800000000000,735.600000000000,684.400000000000,689,701.800000000000,695.600000000000,740,703.400000000000,705.800000000000,703.200000000000,703.600000000000,707.600000000000,697,675.400000000000,688.600000000000,699.800000000000,700,690.600000000000,700.400000000000,776.800000000000,696,707.600000000000,760.200000000000,699.600000000000,709.800000000000,702.600000000000,705.600000000000,726.600000000000,736.400000000000,724.600000000000,706,781.400000000000,737.200000000000,699.200000000000,702.400000000000,692.400000000000,710.400000000000,718.600000000000,707.200000000000,704.200000000000,720,710.600000000000,696.800000000000,689.800000000000,698.400000000000,697.800000000000,692.400000000000,683,677.400000000000,699,706.400000000000,706.400000000000,687.200000000000,732.800000000000,699.600000000000,695,702.800000000000,707.800000000000,719.800000000000,702.400000000000,741.400000000000,692,693.200000000000,705.200000000000,723.200000000000,714.800000000000,694,704.400000000000,694,746.800000000000,687.400000000000,719.600000000000,711.600000000000,690.400000000000,700,678.600000000000,730.200000000000,688.800000000000,695,688.800000000000,701.800000000000,690.600000000000,633.800000000000,720,683,697.600000000000,713.800000000000,665.400000000000,684.600000000000,714.600000000000,681.400000000000,690.200000000000,707.200000000000,690.200000000000,717.800000000000,670,658.200000000000,688.800000000000,702.400000000000,663.400000000000,672.200000000000,712.400000000000,700.400000000000,675.800000000000,695.200000000000,675.600000000000,706.200000000000,709.600000000000,688,627.400000000000,674.400000000000,663.400000000000,697,677.400000000000,702.400000000000,717.400000000000,688.200000000000,696.200000000000,638.600000000000,701.600000000000,693,756.200000000000,695.600000000000,681.800000000000,726.400000000000,665.400000000000,705.400000000000,686.600000000000,680.600000000000,710.600000000000,687.800000000000,685.400000000000,686.600000000000,684.800000000000,693.400000000000,680.800000000000,686.400000000000,683,700.200000000000,692.800000000000,713.400000000000,713.200000000000,704.200000000000,705.400000000000,708.200000000000,704.600000000000,679.200000000000,751.600000000000,690.600000000000,692.800000000000,683,703,673.400000000000,712.200000000000,714.200000000000,697.600000000000,656.600000000000,673.600000000000,708.200000000000,716.600000000000,701.600000000000,712.600000000000,699.400000000000,717.200000000000,684.400000000000,684.200000000000,745.600000000000,722.200000000000,730,742,841.400000000000,3830.20000000000,4608.40000000000,2204.20000000000,1132,703.800000000000,763,712,683.400000000000,667.200000000000,692.800000000000,657.800000000000,697.800000000000,662.600000000000,704.200000000000,675.400000000000,662.400000000000,697.800000000000,691.400000000000,696.400000000000,804,1059,844.200000000000,730.400000000000,689.400000000000,667.400000000000,640,692,676.200000000000,691.400000000000,688.200000000000,702.400000000000,707,665.800000000000,657.600000000000,651.600000000000,666.600000000000,676.200000000000,739.200000000000,653,673,672.200000000000,697.200000000000,705.800000000000,742.800000000000,676.600000000000,693.400000000000,727.400000000000,663.800000000000,679.600000000000,668.200000000000,676.400000000000,657.200000000000,680.400000000000,671,670.600000000000,687.400000000000,687.600000000000,657.400000000000,699.200000000000,697,703,741.800000000000,701.600000000000,669.200000000000,733.400000000000,689.200000000000,714.400000000000,655.400000000000,686.400000000000,672.600000000000,618.400000000000,625.800000000000,718.800000000000,663,737.600000000000,648.800000000000,645.200000000000,705.600000000000,648.400000000000,655.800000000000,634.400000000000,668.800000000000,689,643.200000000000,638,660,652.600000000000,675,645.400000000000,696.200000000000,682.600000000000,659.200000000000,686,672.800000000000,660,688.800000000000,668,725,673.600000000000,644.200000000000,667.800000000000,672.400000000000,620.200000000000,633,686.200000000000,639,662.600000000000,681.600000000000,661.200000000000,629.200000000000,688.400000000000,671,678.600000000000,674,657.200000000000,692.800000000000,622.200000000000,665.800000000000,688.200000000000,688,685.800000000000,671.200000000000,691.800000000000,709,650.600000000000,678.200000000000,680.400000000000,658.600000000000,647.400000000000,680.400000000000,671.200000000000,682,670.200000000000,701.200000000000,701.600000000000,636.200000000000,689.200000000000,674.400000000000,691.600000000000,666,678.400000000000,645.200000000000,677,712.800000000000,664.400000000000,686.200000000000,697.600000000000,678.200000000000,672.400000000000,630.200000000000,669.800000000000,674.600000000000,673.200000000000,665.600000000000,660.800000000000,671,693.800000000000,690.600000000000,674.200000000000,662.200000000000,660.400000000000,688.200000000000,719.800000000000,693.400000000000,678.400000000000,665,675.400000000000,670.600000000000,676.200000000000,653.600000000000,665.600000000000,685.200000000000,652.600000000000,654.400000000000,700.400000000000,659.200000000000,673.200000000000,686,674.800000000000,652,655.800000000000,689,638.800000000000,662.600000000000,656.600000000000,679.200000000000,700.400000000000,662.600000000000,698.200000000000,697.200000000000,740.200000000000,677.600000000000,679.600000000000,700.800000000000,686.800000000000,784.600000000000,3467.80000000000,7929.20000000000,5553.80000000000,2657.80000000000,1244.20000000000,765.800000000000,760.400000000000,686.800000000000,656.600000000000,675.400000000000,673,641,679.200000000000,683,658.800000000000,656.200000000000,654.600000000000,655.600000000000,673.800000000000,652.400000000000,666.600000000000,675.600000000000,636,672.600000000000,661.800000000000,677,660.800000000000,655,614.400000000000,674.800000000000,657.400000000000,700.800000000000,682.400000000000,647.800000000000,682.800000000000,668.200000000000,725.600000000000,675.600000000000,685.400000000000,665,658.200000000000,730.800000000000,676.800000000000,654.400000000000,656.600000000000,675,647.200000000000,700,740,689.800000000000,686.400000000000,717.800000000000,721,659.800000000000,697,699.400000000000,679.800000000000,692.800000000000,675.600000000000,680.600000000000,695.400000000000,682.400000000000,662.400000000000,686,707.200000000000,698.800000000000,636.400000000000,659.600000000000,702.600000000000,639.600000000000,661.200000000000,678.800000000000,671,680,695.800000000000,697.600000000000,666.600000000000,675.800000000000,694.200000000000,704.800000000000,687.600000000000,688.600000000000,640,673,683.200000000000,672.800000000000,691.400000000000,645,665.400000000000,647,625.600000000000,661,689.400000000000,646.800000000000,696,709.400000000000,681.600000000000,686,665.200000000000,650.600000000000,677.200000000000,672.800000000000,637.600000000000,694.200000000000,686.200000000000,700.800000000000,682.800000000000,674.600000000000,662.200000000000,660,632.400000000000,659.800000000000,681.600000000000,641.400000000000,658.600000000000,667,673.600000000000,655.400000000000,651.400000000000,690.600000000000,678.400000000000,676.800000000000,685,680.600000000000,689.600000000000,686,694.800000000000,688.600000000000,681.200000000000,675.400000000000,672,651.400000000000,713.600000000000,698.600000000000,690.200000000000,660.400000000000,700.600000000000,702,700,656.600000000000,679,676.400000000000,698.800000000000,680.800000000000,679.800000000000,659.200000000000,678.600000000000,673.200000000000,699.600000000000,664.400000000000,676.200000000000,727.200000000000,671.200000000000,696.800000000000,663.600000000000,688.400000000000,700.600000000000,685.800000000000,699,674,686.600000000000,663,686,681.800000000000,707.200000000000,748.800000000000,694.800000000000,671.800000000000,743.200000000000,652,661.400000000000,678,676,683,734.200000000000,684.800000000000,699.400000000000,742.600000000000,674.400000000000,669.600000000000,666.400000000000,687.600000000000,679,686.200000000000,661.400000000000,683,648.400000000000,663,714.400000000000,608.400000000000,683.400000000000,661.800000000000,700.600000000000,698.600000000000,645.400000000000,659.800000000000,718,729.800000000000,664.200000000000,668.600000000000,689.400000000000,682,706.800000000000,698.200000000000,684.800000000000,649.200000000000,656,696.600000000000,684.400000000000,683.400000000000,719.200000000000,690.200000000000,672.200000000000,667.200000000000,700,629,695.400000000000,678.200000000000,670.800000000000,674.200000000000,644.600000000000,680,685.400000000000,682.800000000000,668.800000000000,669.400000000000,666.600000000000,667,707.200000000000,664,682.600000000000,671.600000000000,662.400000000000,650.800000000000,666.200000000000,671.800000000000,688.800000000000,698.600000000000,662,671.200000000000,680.800000000000,697,655,658.200000000000,639,699.600000000000,679,673.800000000000,630.400000000000,645.200000000000,626.800000000000,678.400000000000,725.400000000000,684.600000000000,670.200000000000,687.600000000000,706,692.400000000000,693.800000000000,639.400000000000,721.200000000000,730.200000000000,693.200000000000,682.400000000000,700,676,673.800000000000,654,703.800000000000,679.400000000000,679.800000000000,639.600000000000,691.200000000000,677.400000000000,706.400000000000,715.600000000000,641.200000000000,667.200000000000,680,692,718.800000000000,713.200000000000,691,701,674.400000000000,700.600000000000,659.200000000000,659,670.800000000000,699.800000000000,694.400000000000,654.600000000000,696.400000000000,634.400000000000,674,705.800000000000,671.400000000000,701.800000000000,717.200000000000,664.600000000000,682.200000000000,708.200000000000,682.200000000000,689.400000000000,751.600000000000,710,741.800000000000,664.600000000000,668.800000000000,744.400000000000,702.400000000000,678,709.200000000000,691.600000000000,697.200000000000,701.400000000000,673.200000000000,687.200000000000,678.800000000000,677.200000000000,709.600000000000,677,660.600000000000,661.600000000000,743.800000000000,674.600000000000,659.600000000000,688.400000000000,701.400000000000,643.200000000000,721,710.800000000000,620.800000000000,699.800000000000,676.200000000000,711.800000000000,704.200000000000,689.600000000000,681,703.800000000000,685.600000000000,702.600000000000,717.400000000000,706.800000000000,716,704.200000000000,703.800000000000,692.200000000000,713,713.200000000000,691,709,701.200000000000,684,687.800000000000,670.200000000000,736.800000000000,724,705.400000000000,692.400000000000,718.600000000000,692.600000000000,696.200000000000,708.600000000000,703.800000000000,689.800000000000,708.400000000000,705,695.200000000000,683.200000000000,695.800000000000,691.200000000000,711.800000000000,688.200000000000,729,715.600000000000,693.400000000000,710,724.200000000000,715.200000000000,737.800000000000,722.200000000000,697.600000000000,707.800000000000,732.800000000000,724.600000000000,699.400000000000,731.800000000000,703.200000000000,713.800000000000,699.200000000000,703.800000000000,705.800000000000,704.200000000000,671.600000000000,721.800000000000,688.400000000000,694.800000000000,685.800000000000,697.600000000000,740.800000000000,697.200000000000,738,681.800000000000,687.400000000000,716.600000000000,725.600000000000,728.800000000000,704.200000000000,718.800000000000,734.800000000000,711.800000000000,720.800000000000,644.400000000000,734.200000000000,692.800000000000,691.600000000000,705,702.800000000000,695.400000000000,744.200000000000,722.200000000000,651,678.800000000000,739,695.600000000000,735.200000000000,708.400000000000,727.200000000000,720,720.200000000000,720.200000000000,720.200000000000,734.600000000000,734.200000000000,689,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

    if (isCalculating) {
        double m_peak1_resolution;
        double m_peak2_resolution;
        double m_peak3_resolution;

        double  average_resolution= 0;
        double peak1_semiband=0,peak2_semiband=0,peak3_semiband=0;
        int n_interp = 10;
        double array_spectrumvalue[2048] = {0};
        for (int i = 0; i < SPECTRUMPOINTS; i++) {
            array_spectrumvalue[i] = data.at(i);
            //        array_spectrumvalue[i] = test_spec[i];
        }

        average_resolution = Func_Cal_Wave_Resolution(SPECTRUMPOINTS, array_spectrumvalue,peak1,peak2,n_interp);
        peak1_semiband = Func_Cal_semiband_width(SPECTRUMPOINTS, array_spectrumvalue,peak1,n_interp);
        peak2_semiband = Func_Cal_semiband_width(SPECTRUMPOINTS, array_spectrumvalue,peak2,n_interp);
        peak3_semiband = Func_Cal_semiband_width(SPECTRUMPOINTS, array_spectrumvalue,peak3,n_interp);

        m_peak1_resolution = peak1_semiband*average_resolution;
        m_peak2_resolution = peak2_semiband*average_resolution;
        m_peak3_resolution = peak3_semiband*average_resolution;

        ui->lineEdit_resolution1->setText(QString::number(m_peak1_resolution, 'f', 3));
        ui->lineEdit_resolution2->setText(QString::number(m_peak2_resolution, 'f', 3));
        ui->lineEdit_resolution3->setText(QString::number(m_peak3_resolution, 'f', 3));
    }
}
